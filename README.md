# eTrice with Scenario Based Multi-core Multi-tasking
Engine Control Unit (ECU) eTrice Project using Scenario based Multi-core Multi-tasking

## What is the Scenario Based Multi-core Multi-tasking
The paper will be updated later.

## eTrice Project with Scenario Based Multi-core Multi-tasking

In this project, I specially used Engine Control Unit (ECU) Model.  
This project provides reconfigured eTrice runtime system and code modification tool for scenario-based multi-core multi-tasking.   
   
### Requirments    
    
OS : Linux   
eclipse version : oxygen   
eTrice version : 1.1.3    
eTrice language : C    
Python : 3.6    
gcc : 5.5.0        
g++ : 5.5.0    
java : java8        

### How to configure and use tools    
#### 1. Generating code and executable
     
<img src="/img/eTriceSystem.JPG" width="500px" height="400px"></img><br/>    
(eTrice System with Scenario Based Multi-core Multi-tasking)    
    
0. Generate model source code in eTrice: run "generate_Template.launch" at eTrie.    
We assume that you have generated source code files for executable via "generate_Template.launch" of eTrice.        
CodeModifier.py modifies source files generated by eTrice for scenario-based multi-core    
    
1. $ cd elipse-workspace/org.eclipse.etrice.template.c/ 
    
2. $ python3 CodeModifier.py        
  Then, CodeModifier.py will ask you the followings:    
    
2.1 input timer interval (ex: 5000000, which means 5ms):    
    (ex) 5000000    // Default value is 5000000, which is 5ms    
    
2.2. Then, CodeMidifier.py will show the list of threads as follows, which is based on the .etphys file of eTrice.    
Thread List :    
 1.AirflowThread    
 2.AirsysThread    
 3.FuelingsysThread    
 4.IgniactThread    
 5.IgnitionsysThread    
 6.InjectactThread    
 7.PedalThread    
 8.PedaldiagThread    
 9.ThrottleThread    
 10.ThrottleactThread    
    
2.3 map each thread to Core no. (core no. starts from 1) (ex: 1 2, which maps two threads to diffent core):         
    (ex) 4 3 1 2 4 2 1 3 2 4         
    
2.4 assign piroirty no. to each thread (99 to 0 where 0 is the lowest priority) (ex: 99 91 for two threads):     
    (ex) 99 91 92 96 94 95 97 90 98 93      
       
2.5 Then, CodeModifer.py will show the list of actors which invokes timer.startTimer(), which we call "timedActor".     
TimedActor List:    
 1.AccelPedalSensor    
 2.AirSystem    
 3.CylinerNumObserver    
 4.FuelingSystem    
 5.IgnitionActuator        
 6.IgnitionSystem        
 7.InjectionActuator        
 8.MassAirFlowSensor        
 9.PadelDiag        
 10.ThrottleActuator        
 11.ThrottleSensor        
    
2.6 enumerate timedActors that use global resources, which means their accesing threads are not mapped to a single core:         
   (ex) 2 4 5 6 10        
    
2.7 Then, CodeModifer.py will show the list of total actors.    
Actor List:    
 1.AccelPedalDiagEntity    
 2.AccelPedalSensor    
 3.AirMassFlowChanger    
 4.AirMassFlowEntity    
 5.AirSystem    
 6.BassFuelMassEntity    
 7.BassFuelMassEntity2    
 8.CylinerNumObserver    
 9.FuelingSystem        
 10.IgnitionActuator        
 11.IgnitionSystem        
 12.IgnitionTimingActuatorEntity        
 13.IgnitionTimingEntity        
 14.InjectionActuator    
 15.InjectionTimingActuatorEntity    
 16.MassAirFlowSensor    
 17.MessageService_AllThread    
 18.ThrottleActuator    
 19.ThrottleSensor    
 20.TotalFuelingEntity    
 21.TransientFuelingCompensationEntity    
 22.pedalfeel    
 23.pedalvoter    
 24.throttlecontroller    
    
2.8 enumerate any actors that use global resources, which means their accesing threads are not mapped to a single core:     
   (ex) 5 9 10 14 18    
   
2.9 Then, CodeModifier finishes it work.    
    
3. In eTrice, run "run_Template_Lnux.launch", then eTrice will generate "eclipse-        workspace/org.eclipse.etrice.template.c/LinuxPosix/org.eclipse.etrice.template.c.exe")        
    
4. $ cd LinuxPosix    
    
5. $ rm *.txt    
   // This is to remove previoulsy generated time tracing log files, without which the generated time tracing text files will contain wrong information.    
    
6. $ ./org.eclipse.etrice.template.c.exe     
   // It should be executed in the root mode because the pthread library is available only in the root mode.      
       
7. Check the generated text files, whose file names are <actorName>.txt. Each text file should contain time tracing information. (Time tracing text file path : eclipse-workspace/org.eclipse.etrice.template.c/LinuxPosix)            
         
***
#### 2. Timetracing
This project performs time tracing for all scenarios.        
In this project, 11 timing txt files are generated since there are end time files for 10 scenarios and one start time file.    
     
pedalsensor.txt --> Scenario 1 (End time)    
throttlesensor.txt --> Scenario 2 (End time)        
MassAir_inject.txt, MassAir_ignition.txt --> Scenario 3 (End time)        
Pedaldiag.txt --> Scenario 4 (End time)    
airsystem.txt --> Scenario 5 (End time)    
fuelingsystem.txt --> Scenario 6 (End time)    
ignitionsystem.txt --> Scenario 7 (End time)    
throttleactuator.txt --> Scenario 8 (End time)    
injectionactuator.txt --> Scenario 9 (End time)    
ignitionactuator.txt --> Scenario 10 (End time)    
externalQ.txt --> All Scenario (Start time)     
    
1. $ python3 eclipse-workspace/org.eclipse.etrice.template.c/timetrace.py     
    
2. Then, you will get worst-case response time of each scenario.    
(ex)    
S1 worst response time : 3.6002369998022914    
S2 worst response time : 0.3114879997447133    
S3 worst response time : 2.0264720004051924    
S4 worst response time : 0.7038679998368025    
S5 worst response time : 3.1829549996182323    
S6 worst response time : 5.35740299988538    
S7 worst response time : 9.440754999406636    
S8 worst response time : 2.562513000331819    
S9 worst response time : 2.738931999541819    
S10 worst response time : 9.3382449997589    
        
***
#### 3. Configuration of the timing constraints of each actor
As shown in the figure below, you can modify the time consuming code of each actor behavior diagram.    
If you double click transition name, you can see "Edit transition"    
The unit of time used in this model is ms.     
<img src="/img/Timemodify.JPG" width="900px" height="300px"></img><br/>    
    
***
#### 4. Configuration of time scaling factor
Path : eclipse-workspace/org.eclipse.etrice.runtime.c/src/common/debugging/etMSCLogger.h      
Line 26     
    
<pre><code>
#define MULCCS 0.75 // Now, It is performing at three-quarters of the basic constraints. You can modify it to the level you want.
</code></pre>    
    
***
